name: Deploy to GCS (manual o push, con secrets)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Carpeta de deploy (ej: hotfix-cache). Si se deja vacÃ­o, usa YYYYMMDD.'
        required: false
        default: ''

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps
        run: npm ci

      # === AUTH por secrets (clave JSON de Service Account) ===
      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      # Prepara manifest + carpeta versionada:
      # - si se dispara manual con input.version => usa ese valor
      # - si no, usa fecha YYYYMMDD
      - name: Prepare versioned manifest
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "Usando version manual: ${{ github.event.inputs.version }}"
            node scripts/prepare-version.mjs --version=${{ github.event.inputs.version }}
          else
            echo "Sin version manual; usando fecha (YYYYMMDD)"
            node scripts/prepare-version.mjs
          fi

      - name: Build (Vite bundle)
        run: npm run build

      - name: Deploy to GCS
        run: npm run deploy:js && npm run deploy:css && npm run deploy:assets

      - name: Verify uploaded artifacts
        run: |
          BUCKET_PATH=$(cat .bucket_path)
          echo "Archivos subidos a: $BUCKET_PATH"
          gsutil ls -l "$BUCKET_PATH/Visualization.js" || true
          gsutil ls -l "$BUCKET_PATH/Visualization.css" || true
          gsutil ls -l "$BUCKET_PATH/manifest.json" || true
          gsutil ls -l "$BUCKET_PATH/Config.json" || true
