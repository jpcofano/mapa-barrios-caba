name: Deploy to GCS (manual o push, con secrets existentes)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Carpeta de deploy (ej: hotfix-cache). Si se deja vacío, usa YYYYMMDD.'
        required: false
        default: ''

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps
        run: npm ci

      # ===== AUTH por secrets existentes (sin cambiar nombres) =====
      # Toma el PRIMERO que exista entre estos secrets:
      #   GCP_SA_KEY, GOOGLE_CREDENTIALS, GCP_CREDENTIALS, GCP_SA_KEY_JSON
      - name: Resolve credentials secret
        id: creds
        run: |
          if [ -z "${CRED_JSON}" ]; then
            echo "No se encontró ningún secret con credenciales GCP." >&2
            echo "Definí uno de: GCP_SA_KEY, GOOGLE_CREDENTIALS, GCP_CREDENTIALS, GCP_SA_KEY_JSON" >&2
            exit 1
          fi
        env:
          CRED_JSON: ${{ secrets.GCP_SA_KEY || secrets.GOOGLE_CREDENTIALS || secrets.GCP_CREDENTIALS || secrets.GCP_SA_KEY_JSON }}

      - name: Auth to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY || secrets.GOOGLE_CREDENTIALS || secrets.GCP_CREDENTIALS || secrets.GCP_SA_KEY_JSON }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      # ===== Preparar versión (manual o fecha) =====
      - name: Prepare versioned manifest
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "Usando version manual: ${{ github.event.inputs.version }}"
            node scripts/prepare-version.mjs --version=${{ github.event.inputs.version }}
          else
            echo "Sin version manual; usando fecha (YYYYMMDD)"
            node scripts/prepare-version.mjs
          fi

      - name: Build (Vite bundle)
        run: npm run build

      - name: Deploy to GCS
        run: npm run deploy:js && npm run deploy:css && npm run deploy:assets

      - name: Verify uploaded artifacts
        run: |
          BUCKET_PATH=$(cat .bucket_path)
          echo "Archivos subidos a: $BUCKET_PATH"
          gsutil ls -l "$BUCKET_PATH/Visualization.js" || true
          gsutil ls -l "$BUCKET_PATH/Visualization.css" || true
          gsutil ls -l "$BUCKET_PATH/manifest.json" || true
          gsutil ls -l "$BUCKET_PATH/Config.json" || true
