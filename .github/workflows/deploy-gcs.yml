name: Deploy to GCS (manual o push, con secrets existentes)

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      version:
        description: 'Carpeta de deploy (ej: hotfix-cache). Si se deja vacío, usa YYYYMMDD.'
        required: false
        default: ''

jobs:
  build-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install deps
        run: npm ci

      - name: Build (Vite)
        run: npm run build

      # Autenticación SIN JSON usando WIF (como antes)
      - name: Auth to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: gsutil

      # ===== Preparar versión (manual o fecha) =====
      - name: Prepare versioned manifest
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "Usando version manual: ${{ github.event.inputs.version }}"
            node scripts/prepare-version.mjs --version=${{ github.event.inputs.version }}
          else
            echo "Sin version manual; usando fecha (YYYYMMDD)"
            node scripts/prepare-version.mjs
          fi

      - name: Build (Vite bundle)
        run: npm run build

      - name: Deploy to GCS
        run: npm run deploy:js && npm run deploy:css && npm run deploy:assets

      - name: Verify uploaded artifacts
        run: |
          BUCKET_PATH=$(cat .bucket_path)
          echo "Archivos subidos a: $BUCKET_PATH"
          gsutil ls -l "$BUCKET_PATH/Visualization.js" || true
          gsutil ls -l "$BUCKET_PATH/Visualization.css" || true
          gsutil ls -l "$BUCKET_PATH/manifest.json" || true
          gsutil ls -l "$BUCKET_PATH/Config.json" || true
