name: Deploy GCS

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Versi√≥n a usar (ej. V2025)"
        required: true
        default: "V2025"

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- AUTH con WIF (usa tus secrets existentes) ---
      - name: Auth to Google Cloud (WIF)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT_EMAIL }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          install_components: gsutil

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        run: npm ci

      - name: Prepare manifest version
        run: |
          node scripts/prepare-version.mjs \
            --prefix="barrios-caba-map-${{ github.event.inputs.version }}" \
            --version="${{ github.event.inputs.version }}"

      - name: Clean manifest.json (NBSP & spaces)
        run: |
          echo "üîç Revisando manifest.json..."
          cat -v public/manifest.json || true

          # Reemplazar NBSP (0xA0) por espacio normal
          sed -i 's/\xC2\xA0/ /g' public/manifest.json

          # Quitar espacios extra en IDs
          sed -i 's/"id": *"\([^"]*\)"/"id": "\1"/g' public/manifest.json

          echo "‚úÖ Manifest limpio:"
          cat -v public/manifest.json || true

      - name: Build
        run: npm run build

      - name: Deploy JS
        run: |
          BUCKET_PATH=$(cat .bucket_path)
          [[ "$BUCKET_PATH" == gs://mapa-barrios-degcba/* ]] \
            && gsutil -h "Content-Type: application/javascript" \
                      -h "Cache-Control: no-store" \
                      cp dist/Visualization.js "$BUCKET_PATH/Visualization.js"

      - name: Deploy CSS
        run: |
          BUCKET_PATH=$(cat .bucket_path)
          [[ "$BUCKET_PATH" == gs://mapa-barrios-degcba/* ]] \
            && gsutil -h "Content-Type: text/css" \
                      -h "Cache-Control: no-store" \
                      cp dist/Visualization.css "$BUCKET_PATH/Visualization.css"

      - name: Deploy assets
        run: |
          BUCKET_PATH=$(cat .bucket_path)
          [[ "$BUCKET_PATH" == gs://mapa-barrios-degcba/* ]] \
            && gsutil -m cp -r public/* "$BUCKET_PATH/"
